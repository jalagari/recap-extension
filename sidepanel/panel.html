<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recap</title>
  <link rel="stylesheet" href="panel.css">
  <link rel="stylesheet" href="../lib/rrweb-player.min.css">
</head>
<body>
  <div id="app" class="app">
    
    <!-- ============================================ -->
    <!-- HEADER - Always visible -->
    <!-- ============================================ -->
    <header class="header">
      <div class="header-left">
      <div class="logo">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="4" fill="#dc2626"/>
          </svg>
          <span>Recap</span>
        </div>
      </div>
      <div class="header-right">
        <button id="btn-menu" class="btn-icon" title="Menu">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- ============================================ -->
    <!-- VIEWS - Only one visible at a time -->
    <!-- ============================================ -->
    
    <!-- VIEW: No Config Found -->
    <section id="view-no-config" class="view">
      <div class="url-bar">
        <span class="url-icon">ğŸ“</span>
        <span id="current-url" class="url-text">Loading...</span>
      </div>
      
      <div class="status-card status-empty">
        <div class="status-icon">âšª</div>
        <div class="status-text">
          <h3>No configuration found</h3>
          <p>Create one by recording a sample session</p>
        </div>
      </div>
      
      <div class="create-section">
        <h2>ğŸ¬ Create Configuration</h2>
        
        <div class="form-group">
          <label for="form-name">Form Name</label>
          <input type="text" id="form-name" placeholder="Auto-detected or enter name">
        </div>
        
        <button id="btn-start-record" class="btn btn-primary btn-lg">
          <span class="btn-icon">ğŸ”´</span>
          Start Recording
        </button>
        
        <p class="hint">Fill out the form once to capture all fields for configuration.</p>
      </div>
      
      <div class="saved-configs-preview">
        <div class="section-header">
          <h3>ğŸ“‹ Saved Configurations</h3>
          <span id="config-count" class="badge">0</span>
        </div>
        <div id="configs-preview-list" class="configs-preview-list">
          <!-- Populated dynamically -->
        </div>
        <button id="btn-view-all-configs" class="btn btn-link">View All â†’</button>
          </div>
    </section>

    <!-- VIEW: Recording in Progress -->
    <section id="view-recording" class="view hidden">
      <div class="recording-banner">
        <div class="recording-indicator">
          <span class="pulse-dot"></span>
          <span>RECORDING</span>
        </div>
        <span id="recording-time" class="recording-time">00:00</span>
      </div>
      
      <div class="recording-instructions">
        <p>Fill out the form completely.</p>
        <p>Include all steps you want to track.</p>
      </div>
      
      <button id="btn-stop-record" class="btn btn-danger btn-lg">
        <span class="btn-icon">â¹</span>
        Stop Recording
          </button>
      
      <div class="captured-events">
        <h3>Captured Events</h3>
        <div class="filter-tabs filter-tabs-sm">
          <button class="filter-tab active" data-live-filter="all">All</button>
          <button class="filter-tab" data-live-filter="input">âŒ¨ï¸ Input</button>
          <button class="filter-tab" data-live-filter="click">ğŸ–±ï¸ Click</button>
          <button class="filter-tab" data-live-filter="error">âŒ Errors</button>
        </div>
        <div id="live-events" class="fields-list live-events-list">
          <!-- Populated dynamically -->
        </div>
      </div>
    </section>

    <!-- VIEW: Configure Fields (Tabbed Interface) -->
    <section id="view-configure" class="view hidden">
      <div class="configure-header">
        <h2 id="configure-title">Configure</h2>
        <button id="btn-cancel-config" class="btn btn-ghost btn-sm">âœ•</button>
      </div>
      
      <!-- Save button at top -->
      <div class="configure-actions-top">
        <button id="btn-save-config" class="btn btn-primary">ğŸ’¾ Save</button>
        <button id="btn-preview-sample" class="btn btn-secondary">â–¶ Preview</button>
      </div>
      
      <div class="sample-info">
        <span>ğŸ“ <span id="sample-duration">0s</span></span>
        <span>â€¢</span>
        <span><span id="sample-field-count">0</span> fields</span>
      </div>
      
      <!-- Main Configuration Tabs -->
      <div class="config-tabs">
        <button class="config-tab active" data-config-tab="fields">ğŸ“ Fields</button>
        <button class="config-tab" data-config-tab="quality">ğŸ“Š Quality</button>
        <button class="config-tab" data-config-tab="settings">âš™ï¸ Settings</button>
      </div>
      
      <!-- TAB 1: Fields -->
      <div id="config-tab-fields" class="config-tab-content active">
        <div class="actions-legend">
          <span class="legend-item"><span class="legend-icon">ğŸ”’</span> Mask</span>
          <span class="legend-item"><span class="legend-icon">ğŸš«</span> Ignore</span>
          <span class="legend-item"><span class="legend-icon">ğŸ“</span> Step</span>
        </div>
        
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">All</button>
          <button class="filter-tab" data-filter="input">âŒ¨ï¸</button>
          <button class="filter-tab" data-filter="click">ğŸ–±ï¸</button>
          <span class="filter-divider">|</span>
          <button class="filter-tab" data-filter="masked">ğŸ”’</button>
          <button class="filter-tab" data-filter="clear">âœ…</button>
          <button class="filter-tab" data-filter="ignored">ğŸš«</button>
          <button class="filter-tab" data-filter="steps">ğŸ“</button>
        </div>
        
        <div id="fields-list" class="fields-list">
          <!-- Populated dynamically -->
        </div>
      </div>
      
      <!-- TAB 2: Quality Detection -->
      <div id="config-tab-quality" class="config-tab-content hidden">
        <div class="quality-header">
          <h3>Session Quality Detection</h3>
          <label class="toggle-switch">
            <input type="checkbox" id="quality-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="quality-body" id="quality-body">
          <div class="settings-card">
            <h4>ğŸ¯ Signal Weights</h4>
            <p class="settings-hint">Points per occurrence (higher = more impact)</p>
            
            <div class="weight-grid">
              <div class="weight-row">
                <span>ğŸ’¥ JS Error</span>
                <input type="number" id="weight-jsError" value="40" min="0" max="100">
              </div>
              <div class="weight-row">
                <span>ğŸŒ Network Error</span>
                <input type="number" id="weight-networkError" value="40" min="0" max="100">
              </div>
              <div class="weight-row">
                <span>ğŸ˜¤ Rage Click</span>
                <input type="number" id="weight-rageClick" value="25" min="0" max="100">
              </div>
              <div class="weight-row">
                <span>ğŸšª Abandonment</span>
                <input type="number" id="weight-formAbandonment" value="20" min="0" max="100">
              </div>
              <div class="weight-row">
                <span>ğŸ”„ Validation Loop</span>
                <input type="number" id="weight-validationLoop" value="15" min="0" max="100">
              </div>
              <div class="weight-row">
                <span>ğŸ‘† Dead Click</span>
                <input type="number" id="weight-deadClick" value="10" min="0" max="100">
              </div>
            </div>
          </div>
          
          <div class="settings-card">
            <h4>ğŸ“ Thresholds</h4>
            <div class="threshold-grid">
              <div class="threshold-row critical">
                <span>ğŸš¨ Critical</span>
                <input type="number" id="threshold-critical" value="80" min="0" max="200">
              </div>
              <div class="threshold-row review">
                <span>âš ï¸ Review</span>
                <input type="number" id="threshold-review" value="50" min="0" max="200">
              </div>
            </div>
            <p class="settings-hint">Score â‰¥ Critical â†’ Alert | Score â‰¥ Review â†’ Flag</p>
          </div>
        </div>
      </div>
      
      <!-- TAB 3: Settings -->
      <div id="config-tab-settings" class="config-tab-content hidden">
        <div class="settings-card">
          <h4>âœ… Form Completion</h4>
          <p class="settings-hint">CSS selector for success state (detects form completion)</p>
          <input type="text" id="completion-selector" class="settings-input" 
                 placeholder=".success-message, #thank-you, [data-recap-complete]">
        </div>
        
        <div class="settings-card">
          <h4>ğŸ› Report Button</h4>
          <p class="settings-hint">Let users report issues during the session</p>
          
          <div class="setting-row">
            <label class="checkbox-label">
              <input type="checkbox" id="report-enabled">
              <span>Enable Report Button</span>
            </label>
          </div>
          
          <div class="setting-row">
            <label>Show Mode</label>
            <select id="report-mode">
              <option value="on_error">On Error (when issues detected)</option>
              <option value="always">Always Visible</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
        </div>
        
        <div class="settings-card">
          <h4>ğŸ“Š Sampling</h4>
          <p class="settings-hint">Percentage of sessions to record</p>
          <div class="setting-row">
            <label>Sample Rate</label>
            <select id="sampling-rate">
              <option value="1">100% (All sessions)</option>
              <option value="0.5">50%</option>
              <option value="0.25" selected>25%</option>
              <option value="0.1">10%</option>
              <option value="0.05">5%</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: Config Exists (Main Dashboard) -->
    <section id="view-dashboard" class="view hidden">
      <div class="url-bar">
        <span class="url-icon">ğŸ“</span>
        <span id="dashboard-config-name" class="url-text">Config Name</span>
        <button id="btn-edit-config" class="btn-icon" title="Edit">âœï¸</button>
              </div>
      
      <div class="status-card status-active">
        <div class="status-icon">âœ…</div>
        <div class="status-text">
          <h3>Configuration Active</h3>
          <div class="status-badges">
            <span class="badge badge-clear" title="Clear fields (not masked)">âœ… <span id="mask-count">0</span></span>
            <span class="badge badge-ignore" title="Ignored fields">ğŸš« <span id="ignore-count">0</span></span>
            <span class="badge badge-step" title="Steps">ğŸ“ <span id="step-count">0</span></span>
            </div>
          </div>
        </div>

      <div class="stats-section">
        <h3>ğŸ“Š Quick Stats</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-sessions">0</div>
            <div class="stat-label">Sessions</div>
              </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-complete">0%</div>
            <div class="stat-label">Complete</div>
            </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-errors">0%</div>
            <div class="stat-label">Errors</div>
            </div>
          </div>
        </div>

      <div class="recent-sessions">
        <div class="section-header">
          <h3>Recent Sessions</h3>
          <button id="btn-view-sessions" class="btn btn-link">View All â†’</button>
            </div>
        <div id="recent-sessions-list" class="sessions-list">
          <!-- Populated dynamically -->
            </div>
          </div>

      <div class="dashboard-actions">
        <button id="btn-rerecord" class="btn">ğŸ”„ Re-record</button>
        <button id="btn-export-config" class="btn">ğŸ“¤ Export JSON</button>
        <button id="btn-export-embed" class="btn btn-primary">ğŸš€ Export Embed Script</button>
      </div>
    </section>

    <!-- VIEW: All Configurations -->
    <section id="view-configs" class="view hidden">
      <div class="view-header">
        <button id="btn-back-from-configs" class="btn-back">â† Back</button>
        <h2>All Configurations</h2>
      </div>
      
      <div class="search-bar">
        <input type="text" id="search-configs" placeholder="Search configs...">
      </div>
      
      <div id="all-configs-list" class="configs-list">
        <!-- Populated dynamically -->
      </div>
      
      <div class="list-actions">
        <button id="btn-import-config" class="btn">ğŸ“¥ Import Config</button>
        <input type="file" id="import-config-file" accept=".json" hidden>
            </div>
    </section>

    <!-- VIEW: All Sessions -->
    <section id="view-sessions" class="view hidden">
      <div class="view-header">
        <button id="btn-back-from-sessions" class="btn-back">â† Back</button>
        <h2>Sessions</h2>
            </div>
      
      <div class="filter-bar">
        <select id="filter-config">
          <option value="">All Forms</option>
        </select>
        <select id="filter-status">
          <option value="">All Status</option>
          <option value="complete">âœ… Complete</option>
          <option value="error">âŒ Error</option>
          <option value="dropped">â¸ Dropped</option>
        </select>
          </div>

      <div id="all-sessions-list" class="sessions-list">
        <!-- Populated dynamically -->
      </div>
    </section>

    <!-- VIEW: Session Replay -->
    <section id="view-replay" class="view hidden">
      <div class="view-header">
        <button id="btn-back-from-replay" class="btn-back">â† Back</button>
        <h2>Session Replay</h2>
            </div>
      
      <div class="replay-meta">
        <span id="replay-session-id" class="session-id">#---</span>
        <span id="replay-status" class="status-badge">---</span>
        <span id="replay-duration">00:00</span>
            </div>
      
      <div id="replay-container" class="replay-container">
        <!-- rrweb player renders here -->
          </div>

      <div id="replay-controls" class="replay-controls">
        <!-- Custom controls if needed -->
            </div>
    </section>

    <!-- VIEW: Analytics -->
    <section id="view-analytics" class="view hidden">
      <div class="view-header">
        <button id="btn-back-from-analytics" class="btn-back">â† Back</button>
        <h2>Analytics</h2>
            </div>
      
      <div class="filter-bar">
        <select id="analytics-config">
          <option value="">Select Form</option>
        </select>
        <select id="analytics-period">
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
          </div>

      <div class="analytics-content">
        <div class="funnel-section">
          <h3>Drop-off Funnel</h3>
          <div id="funnel-chart" class="funnel-chart">
            <!-- Populated dynamically -->
          </div>
        </div>

        <div class="errors-section">
          <h3>Error Breakdown</h3>
          <div id="error-breakdown" class="error-list">
            <!-- Populated dynamically -->
        </div>
      </div>

        <div class="dropoff-section">
          <h3>Top Drop-off Fields</h3>
          <div id="dropoff-fields" class="dropoff-list">
            <!-- Populated dynamically -->
          </div>
        </div>
        </div>
      </section>

    <!-- VIEW: Menu -->
    <section id="view-menu" class="view hidden">
      <div class="view-header">
        <button id="btn-close-menu" class="btn-back">â† Back</button>
        <h2>Menu</h2>
      </div>
      
      <nav class="menu-nav">
        <button id="menu-configs" class="menu-item">
          <span class="menu-icon">ğŸ“‹</span>
          <span class="menu-label">All Configurations</span>
          <span id="menu-config-count" class="menu-badge">0</span>
        </button>
        <button id="menu-sessions" class="menu-item">
          <span class="menu-icon">ğŸ¬</span>
          <span class="menu-label">All Sessions</span>
          <span id="menu-session-count" class="menu-badge">0</span>
        </button>
        <button id="menu-analytics" class="menu-item">
          <span class="menu-icon">ğŸ“Š</span>
          <span class="menu-label">Analytics Dashboard</span>
        </button>
      </nav>

      <hr class="menu-divider">
      
      <nav class="menu-nav">
        <button id="menu-settings" class="menu-item">
          <span class="menu-icon">âš™ï¸</span>
          <span class="menu-label">Settings</span>
        </button>
        <button id="menu-export-all" class="menu-item">
          <span class="menu-icon">ğŸ“¤</span>
          <span class="menu-label">Export All Data</span>
              </button>
        <button id="menu-import" class="menu-item">
          <span class="menu-icon">ğŸ“¥</span>
          <span class="menu-label">Import Configuration</span>
              </button>
      </nav>
    </section>

    <!-- VIEW: Settings -->
    <section id="view-settings" class="view hidden">
      <div class="view-header">
        <button id="btn-back-from-settings" class="btn-back">â† Back</button>
        <h2>Settings</h2>
            </div>
            
      <div class="settings-content">
        <div class="setting-group">
          <h3>Recording Defaults</h3>
          
          <div class="setting-item">
            <label>Default Sampling Rate</label>
            <div class="setting-control">
              <input type="range" id="default-sampling" min="1" max="100" value="25">
              <span id="sampling-value">25%</span>
          </div>
        </div>

          <div class="setting-item">
            <label>Capture Console Errors</label>
            <input type="checkbox" id="capture-console" checked>
          </div>
          
          <div class="setting-item">
            <label>Capture Network Requests</label>
            <input type="checkbox" id="capture-network" checked>
          </div>
        </div>

        <div class="setting-group">
          <h3>Storage</h3>
          
          <div class="setting-item">
            <label>Storage Backend</label>
            <select id="storage-backend">
              <option value="indexeddb">Browser (IndexedDB)</option>
              <option value="api">Remote API</option>
            </select>
            </div>
          
          <div class="setting-item" id="api-url-setting" style="display:none">
            <label>API Endpoint</label>
            <input type="text" id="api-url" placeholder="https://api.example.com/recap">
        </div>
      </div>

        <div class="setting-group">
          <h3>Data Management</h3>
          <button id="btn-clear-sessions" class="btn btn-danger">Clear All Sessions</button>
          <button id="btn-clear-all" class="btn btn-danger">Clear All Data</button>
  </div>
      </div>
    </section>

  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Modal for Replay -->
  <div id="modal-replay" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>Session Replay</h3>
        <button class="modal-close">Ã—</button>
      </div>
      <div id="modal-player-container" class="modal-body"></div>
    </div>
  </div>

  <!-- Modal for Export Embed Script -->
  <div id="modal-export" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3>ğŸš€ Production Embed Script</h3>
        <button class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- Content populated by JS -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../lib/rrweb.min.js"></script>
  <script src="../lib/rrweb-player.min.js"></script>
  
  <!-- App (ESM) -->
  <script type="module" src="lib/app.js"></script>
</body>
</html>
